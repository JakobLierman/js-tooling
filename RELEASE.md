# Release Process

This monorepo uses a single automated release workflow that handles all release types based on the branch or manual trigger. The release process is designed to only release packages that have actual changes, avoiding unnecessary releases.

## Release Types

### Production Releases (`main` branch)

- **Trigger**: Push to `main` branch or manual trigger with "production" type
- **Version**: Uses changesets for proper semantic versioning
- **NPM Tag**: `latest`
- **Git Tags**: Created automatically by changesets action
- **Git Commits**: Version bumps and changelog updates committed by changesets
- **Registry**: GitHub Packages
- **Changelog**: Generated by changesets from changeset files
- **Process**: Creates PR for version bumps, then publishes on merge

### Beta Releases (`staging` branch)

- **Trigger**: Push to `staging` branch or manual trigger with "beta" type
- **Version**: Creates beta snapshot releases (e.g., `1.0.0` → `1.1.0-beta.1`)
- **NPM Tag**: `beta`
- **Git Tags**: Created for each package (e.g., `@jakoblierman/commitlint-config@1.1.0-beta.1`)
- **Git Commits**: Version bumps and changelog updates committed automatically
- **Registry**: GitHub Packages
- **Changelog**: Generated by changesets from changeset files
- **Process**: Direct publish without PR (snapshot release)

## How It Works

### Production Releases (main branch)

1. **Test Execution**: All tests must pass before release
2. **Changeset Detection**: Changesets detects packages with changeset files
3. **Version Bumping**: Changesets creates PR with version bumps and changelog updates
4. **Review Process**: PR is reviewed and merged
5. **Publishing**: Changesets publishes packages on PR merge
6. **Git Operations**: Changesets handles git commits and tags automatically

### Beta Releases (staging branch)

1. **Test Execution**: All tests must pass before release
2. **Changeset Detection**: Changesets detects packages with changeset files
3. **Snapshot Versioning**: Creates snapshot versions (e.g., `1.1.0-beta.1`)
4. **Git Tagging**: Creates git tags for each package (e.g., `@package@1.1.0-beta.1`)
5. **Direct Publishing**: Publishes immediately with appropriate npm tags
6. **Git Commits**: Commits version bumps and changelog updates
7. **Git Push**: Pushes commits and tags to repository

## Test Workflow

The release process is protected by comprehensive testing:

### Test Jobs

- **Linting**: Code style and quality checks
- **Type Checking**: TypeScript type validation
- **Unit Tests**: All test suites must pass
- **Security Audit**: Dependency vulnerability scanning
- **Build Verification**: Ensures all packages build successfully

### Test Triggers

- **Push to branches**: Runs tests on every push to `main` or `staging`
- **Pull Requests**: Runs tests on every PR to protected branches
- **Status Checks**: PRs require all tests to pass before merging

### Release Blocking

- **Release Prevention**: If any test fails, the release workflow will not run
- **Quality Gate**: Only code that passes all tests can be released
- **Automatic Protection**: No manual intervention needed to prevent bad releases

## Manual Release

You can trigger releases in two ways:

### 1. GitHub Actions Manual Trigger

- Go to the "Actions" tab in your GitHub repository
- Select the "Release" workflow
- Click "Run workflow"
- Choose the release type (production, beta)
- Click "Run workflow"

### 2. Local Changeset Commands

```bash
# Add a changeset for a package
pnpm changeset

# Version packages (updates package.json versions)
pnpm changeset version

# Publish packages to registry
pnpm changeset publish
```

## Using Changesets

### Adding Changes

When you make changes to a package, add a changeset:

```bash
pnpm changeset
```

This will:

1. Ask which packages you've changed
2. Ask what type of change (patch, minor, major)
3. Ask for a description of the change
4. Create a changeset file in `.changeset/`

### Release Process

1. **Automatic**: Push to `main` branch triggers the release workflow
2. **Manual**: Use GitHub Actions manual trigger
3. **Local**: Run `pnpm changeset version` then `pnpm changeset publish`

## Prerequisites

- GitHub Packages access token (automatically provided by GitHub Actions)
- Conventional commit messages for proper changelog generation
- Packages must be built before release

## Changelog Generation

Changelogs are automatically generated by changesets based on the changeset files you create. This ensures consistent and well-formatted changelogs based on your changeset descriptions.

## Package Structure

Each package in the `packages/` directory is treated as a separate releasable unit. The system will:

1. Check if the package has changes
2. Update the version in `package.json`
3. Generate/update `CHANGELOG.md`
4. Publish to GitHub Packages
5. Create a GitHub release

## Workflow Files

The CI/CD system consists of two main workflows:

### 1. Test Workflow (`.github/workflows/test.yml`)

- **Triggers**: Push to branches, Pull Requests, Reusable workflow
- **Purpose**: Comprehensive testing and quality checks
- **Jobs**:
  - **Test Job**: Linting, testing with coverage, type checking, security audit, build verification
  - **PR Comment Job**: Optional PR status comments
- **Features**: Coverage reports, artifact upload, reusable by other workflows

### 2. Release Workflow (`.github/workflows/release.yml`)

- **Triggers**: Push to branches, Manual dispatch
- **Purpose**: Automated package releases
- **Dependencies**: Uses the test workflow as a reusable workflow
- **Blocking**: Only runs if tests pass

## Configuration

The release process is configured through:

- `.github/workflows/` - GitHub Actions workflows
- `scripts/release.js` - Custom release script
- `turbo.json` - Build and test dependencies
- `package.json` - Release scripts and dependencies

## Troubleshooting

If a release fails:

1. Check the GitHub Actions logs for specific error messages
2. Ensure all packages build and test successfully
3. Verify GitHub Packages access permissions
4. Check that commit messages follow conventional commit format

## Branch Strategy

- `staging` → Beta releases
- `main` → Production releases

This allows for a proper release pipeline where features flow through beta → production stages.
